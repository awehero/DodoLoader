<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://awehero.github.io/DodoLoader/libraries/jquery.js"></script>

    <title>Ice Dodo - UnOfficial Site</title>
    <link rel="icon" href="https://awehero.github.io/DodoLoader/assets/icons/icon.png">
    <meta name="description" content="Play hundreds of 3D Ice dodo levels. Do not fall off or touch spikes.">

    <script type="module" crossorigin src="https://awehero.github.io/DodoLoader/assets/index.js"></script>
    <script type="module" src="https://awehero.github.io/DodoLoader/dodoCup.js"></script>
    <link rel="stylesheet" href="https://awehero.github.io/DodoLoader/assets/index.css">
    <style>
        .button {
            margin-bottom:5px;
            margin-top:5px;
            border: 4px solid #bbbbbb;
            border-radius: 10px;
            background-color: transparent;
            color:white;
            cursor: pointer;
        }
        .button:hover {
            background: #8A0468;
        }
        input[type=text] {
            width:2vw;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        p {
            margin: 2px;
        }
    </style>
  </head>
  <body>
    <div id="appContainer">
      <div style="position:absolute;top:0;left:0;width:100vw;height:100vh;box-sizing:border-box;" id="app"></div>
    </div>
    <img id="validation" src="https://awehero.github.io/DodoLoader/assets/icons/validation.svg" alt="validation" style="position:absolute;right:-15px;bottom:50px;width:20vh">
    <button id="pause" style="width:4vw;height:4vw;position:absolute;left:25px;top:100px;background:none;border:none;cursor:pointer;">
        <img src="https://awehero.github.io/DodoLoader/assets/icons/pause.svg" alt="pause" style="width: 100%;">
    </button>
    <div id="pauseCountDown" style="position:absolute;top:50%;left:50%;font-size:3vw;color:white;display:none;width:5vw;height:5vw;background-color:gray;transform:translate(-50%,-50%);border-radius:5px;">
        <h1 style="position:relative;top:50%;transform:translateY(-50%);">3</h1>
    </div>
    <div id="preroll"></div>
    <div id="ModMenu">
        <div id="ModMenuContent" style="opacity: 75%;position:absolute;top:0;right:5vw;width:17vw;border:rgb(59, 59, 59) 1px solid;background-color: rgb(39, 39, 39);border-radius: 0 0 5px 5px;overflow-y: auto;">
            <button id="togglemenu" class="modbutton">ModMenu (click)</button>
            <div class="modmenuOption">
                <botton class="button" onclick="window.location.href='../'">Back To Config</botton>
                <br>
                <input id="spin" type="checkbox">
                <label>Turn Off Spin</label>
                <br>
                <!-- <input id="PracticeMode" type="checkbox"> -->
                <!-- <label>Practice Mode</label> -->
                <!-- <p>Cords + Rotation(0.0-1.0)</p>
                <input type="number" id="PracticeX" style="width:2vw">
                <input type="number" id="PracticeY" style="width:2vw">
                <input type="number" id="PracticeZ" style="width:2vw">
                <input type="number" id="PracticeR" style="width:2vw">
                <br> -->
                <button id="togglecheats" class="modbutton">Cheats</button>
                <div id="cheats">
                    <input id="godmode" type="checkbox">
                    <label>Godmode</label>
                    <br>
                    <input id="gravityoverwrite" type="checkbox">
                    <label>Overwrite Gravity?</label>
                    <br>
                    <!-- <input id="gravity" type="number" > -->
                    <div id="gravitytoggle">
                        <input type="range" min="-18" max="0" id="gravity" step="1">
                        <p style="display:block;margin:0;" id="gravityindicator">0</p> 
                    </div>

                    <input id="speedoverwrite" type="checkbox">
                    <label>Overwrite speed?</label>
                    <br>
                    <!-- <input id="speed" type="number" > -->
                    <div id="speedtoggle">
                        <input type="range" min="0" max="1" id="speed" step=".02">
                        <p style="display:block;margin:0;" id="speedindicator">0.28</p>
                    </div>
                    <!-- <input id="steerControl" type="input"> -->
                    <label for="steerControl">Steer Adjust (1 default)</label>
                    <input type="range" min="0.1" max="5" id="steerControl" step=".1">
                    <br><label id="steerindicator">Steer Speed (1 default)</label>
                    <br>
                    <input style="display: inline-block;width:1vw" type="number" id="spawnX"><label for="spawnX">Spawn X</label><br>
                    <input style="display: inline-block;width:1vw" type="number" id="spawnY"><label for="spawnY">Spawn Z</label><br>
                    <input style="display: inline-block;width:1vw" type="number" id="spawnZ"><label for="spawnZ">Spawn Y</label><br>
                    <input style="display: inline-block;width:1vw" type="number" id="spawnR"><label for="spawnR">Spawn R</label>
                    <br>
                    <botton class="button" onclick="window.tsTriggers.onWin()">Instant Win</botton>
                </div>
                <button id="toggledodocontrols" class="modbutton">Dodo Cinematics</button>
                <!-- <button id="testbutton" class="modbutton">Dodo rotation</button> -->
                <div id="dodocontrols">
                    <input id="freecam" type="checkbox">
                    <label>FreeCam</label>
                    <br>
                    <input id="freeze" type="checkbox" >
                    <label >Freeze Dodo</label>
                    <br >
                    <input id="follow" type="checkbox" >
                    <label >Follow Player</label>
                    <div id="followtoggle">
                        <input type="range" min=".5" max="150" id="followdistance" step=".5">
                        <p style="display:block;margin:0;" id="followindicator">Max distance.5</p>

                        <input type="range" min="2.5" max="25" id="followheight" step=".1">
                        <p style="display:block;margin:0;" id="followheightindicator">Max height: 2</p>
                        <p>Start Position</p>
                        <select id="FollowStart">
                            <option value="c">Center</option>
                            <option value="l">Left</option>
                            <option value="r">Right</option>
                        </select>
                    </div>
                    <br >
                </div>






              
                <button id="toggletascontrols" class="modbutton">TAS Tool</button>
                <div id="tascontrols">
                    <input id="watchreplay" type="checkbox">
                    <label>Watch Replay</label>
                    <br>
                    <input id="tas2" type="checkbox" >
                    <label >Freeze Dodo</label>
                    <br >
                    <input id="tas3" type="checkbox" >
                    <label >Follow Player</label>
                    <div id="tas4">
                        <input type="range" min=".5" max="150" id="tas5" step=".5">
                        <p style="display:block;margin:0;" id="followindicator">Max distance.5</p>

                        <input type="range" min="2.5" max="25" id="tas6" step=".1">
                        <p style="display:block;margin:0;" id="tas7">Max height: 2</p>
<!--
                        <input type="range" min="1" max="15" id="followspeed" step=".5">
                        <p style="display:block;margin:0;" id="followspeedindicator">Follow speed: 1</p> -->
                        <p>Start Position</p>
                        <select id="tas8">
                            <option value="c">Center</option>
                            <option value="l">Left</option>
                            <option value="r">Right</option>
                        </select>
                    </div>
                    <br >
                    <!-- <p style="margin: 0;">Movement</p>
                    <div class="container">
                        <div class="home"><button id="home" class="dodocontrolButton">Home</button></div>
                        <div class="up"><button id="up" class="dodocontrolButton">Up</button></div>
                        <div class="left"><button id="left" class="dodocontrolButton">Left</button></div>
                        <div class="right"><button id="right" class="dodocontrolButton">Right</button></div>
                        <div class="down"><button id="down" class="dodocontrolButton">Down</button></div>
                        <div class="foreward"><button id="foreward" class="dodocontrolButton">Forewards</button></div>
                        <div class="backward"><button id="backward" class="dodocontrolButton">Backwards</button></div>
                    </div>
                    <p style="margin: 0;">Rotation</p>
                    <div class="container">
                        <div class="home"><button id="Chome" class="dodocontrolButton">Home</button></div>
                        <div class="up"><button id="Cup" class="dodocontrolButton">Up</button></div>
                        <div class="left"><button id="Cleft" class="dodocontrolButton">Left</button></div>
                        <div class="right"><button id="Cright" class="dodocontrolButton">Right</button></div>
                        <div class="down"><button id="Cdown" class="dodocontrolButton">Down</button></div>
                    </div> -->
                </div>





              
              
                <input id="AutoCheckpoint" type="checkbox">
                <label>Auto Checkpoint</label>
                <p>Checkpoint Shape</p>
                <select id="CheckpointShape">
                    <option value=12>Diamond</option>
                    <option value="cube">Cube</option>
                    <option value="sphere">Sphere</option>
                </select>
                <button id="togglechallages" class="modbutton">Dodo Challanges</button>
                <div id="challangeMenu">
                    <input type="checkbox" id="fog">
                    <label for="fog">Fog</label>
                    <br>
                    <input type="checkbox" id="invis">
                    <label for="invis">Invisibility</label>
                    <br>
                    <input type="checkbox" id="fpv">
                    <label for="fpv">First Person</label>
                    <!-- <br>
                    <input type="checkbox" id="ghostly">
                    <label for="ghostly">Ghostly</label> -->
                </div>
                <br>
                <button class="button" id="resetlevel">Reset Level</button>
                <br><input id="preview" type="checkbox">
                <label>Preview Level (beta)</label>
                		            <br>

                        				<input id="MouseControls" type="checkbox">
                        				<label for="MouseControls">Mouse Controls</label>
                        				<br>
                        				<input id="overwriteMouseControls" type="checkbox">
                        				<label id="overwriteMouseControlsText" for="overwriteMouseControls">Overwrite Steer Speed</label>
                        				<br>
                        				<input type="range" min="0.1" max="2" id="MouseControlsSensitivity" step=".1">
                        				<br>
                        				<label id="MouseControlsText">Sensitivity (1 default)</label>
                        
                        				<br><br>
                        				<input id="AltMobileControls" type="checkbox">
                        				<label for="AltMobileControls">Alt Mobile Controls</label>
            </div>
        </div>
    </div>
    <div id="LevelEditor">
        <div id="LevelEditorContent" style="opacity: 100%;position:absolute;top:0;left:10vw;width:15vw;border:rgb(59, 59, 59) 1px solid;background-color: rgb(39, 39, 39);border-radius: 0 0 5px 5px;-index:-1">
            <button id="toggleLevelEditor" class="modbutton">LevelEditor (click)</button>
            <div class="LevelEditorOption">
                <button id="toggleLevelEditorObjects" class="modbutton">LevelEditor Objects</button>
                <div class="LevelEditorObjects" style="max-height:25vh;overflow-y: auto;">
                    <button class="button" id="GetAllObjects">get All Objects (emergency)</button>
                    <button class="button" id="DeleteAllMadeObjects">Delete All (made) Objects</button>
                    <button class="button" id="DeleteSelectedMadeObjects">Delete Selected Object</button>
                    <br>
                    <select id="ObjectSelector"><option> </option></select>
                </div>
                <button id="toggleLevelEditorAdd" class="modbutton">LevelEditor Add</button>
                <div class="LevelEditorAdd">
                    <button id="addBox" class="button">add box</button><br>
                    <button id="addcylinder" class="button">add cylinder</button>
                </div>
                <button id="toggleLevelEditorControl" class="modbutton">LevelEditor Control</button>
                <div class="LevelEditorControl">
                    <p>Position</p>
                    <input type="text" id="x"><input type="text" id="y"><input type="text" id="z">
                    <p>Rotation</p>
                    <input type="text" id="xr"><input type="text" id="yr"><input type="text" id="zr">
                    <p>Scale</p>
                    <input type="text" id="xs"><input type="text" id="ys"><input type="text" id="zs">
                    <br>
                    <p>Texture</p>
                        <select id="TextureSelector">
                            <option value=""></option>
                            <option value="bright.png">Bright</option>
                            <option value="dark.png">Dark</option>
                            <option value="flare.png">Flare</option>
                            <option value="icedd.png">Icedd</option>
                            <option value="pm1.png">PM1</option>
                            <option value="pm2.png">PM2</option>
                        </select>
                    <br>
                    <button class="button" id="ControlButton">Set</button>
                    <br>
                    <button class="button" id="Export">Export Level</button>
                    <textarea style="color:black;font-size: xx-small;font-family: arial;" id="ExportMap"></textarea>
                </div>
            </div>
        </div>
    </div>
    <div style="position:absolute;background-color: #272727;color:white;top:0;left:26vw;border:1px #3b3b3b solid;border-radius: 5px;" id="levelPercent">
        <label for="progress" id="progressPercent">Level Progress: Null</label>
        <progress id="progress" value=".5" max="100" style="width:40vw;"></progress>
    </div>

        <button id="fullscreen" style="position:absolute;top:0;left:0;width:100px;height:20px;background:white;z-index:999;">fullscreen</button>
      	<button id="RightMobile" style="position:absolute;left:calc(40px + 10vw);bottom:10px;width:13vw;height:10vw;background:rgba(227, 75, 75, .25);border:white 2px solid;z-index:999;">
      		      <img src="../assets/svgs/caret-right-fill.svg" style="width:90%;height: 90%;">
      	</button>
      	<button id="LeftMobile" style="position:absolute;left:10px;bottom:10px;width:13vw;height:10vw;background:rgba(75, 75, 227, .25);border:white 2px solid;z-index:999;">
      		      <img src="../assets/svgs/caret-left-fill.svg" style="width:90%;height: 90%;">
      	</button>
      	<button id="MobileJump" style="position:absolute;right:10px;bottom:10px;width:13vw;height:10vw;background:rgba(75, 227, 75, .25);border:none;cursor:pointer;">
      		      <img src="../assets/svgs/jumpButton.svg" style="width:90%;height: 90%;">
      	</button>
      	<button id="MobileDrift" style="position:absolute;right:10px;bottom:calc(20px + 10vh * 2);width:13vw;height:10vw;background:rgba(75, 227, 75, .25);border:none;cursor:pointer;">
      		      <img src="../assets/svgs/driftMobile.svg" style="width:90%;height: 90%;">
      	</button>
    
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/decorations.js?v=0.179"></script>
    <script type="text/javascript">
        $(document).ready(function () {
                        function isMobile() {
                  				var userAgent = navigator.userAgent || navigator.vendor || window.opera;
                  				return /android|iPad|iPhone|iPod/i.test(userAgent);
                  			}
                  
                  			function requestFullscreenAndLockOrientation() {
                  				if (document.documentElement.requestFullscreen) {
                  					document.documentElement.requestFullscreen().then(() => {
                  						if (screen.orientation && screen.orientation.lock) {
                  							screen.orientation.lock('landscape').catch(err => {
                  								console.error('Failed to lock orientation:', err);
                  							});
                  						}
                  					}).catch(err => {console.error('Failed to enter fullscreen mode:', err);});
                  				}
                  			}
                  
                  			function exitFullscreenAndUnlockOrientation() {
                  				if (document.exitFullscreen) {
                  					document.exitFullscreen().then(() => {
                  						if (screen.orientation && screen.orientation.unlock) {
                  							screen.orientation.unlock().catch(err => {
                  								console.error('Failed to unlock orientation:', err);
                  							});
                  						}
                  					}).catch(err => {console.error('Failed to exit fullscreen mode:', err);});
                  				}
                  			}
                  
                  
                  
                  			if (isMobile()) {
                  				// alert("PHONE");
                  				$("#validation").hide();
                  				$("#RightMobile").show();
                  				$("#LeftMobile").show();
                  				$("#MobileJump").show();
                  				$("#MobileDrift").show();
                  				$("#AltMobileControls").show();
                  				document.getElementById('MobileJump').addEventListener('contextmenu', function(e) {
                  					e.preventDefault();
                  				});
                  				document.getElementById('LeftMobile').addEventListener('contextmenu', function(e) {
                  					e.preventDefault();
                  				});
                  				document.getElementById('RightMobile').addEventListener('contextmenu', function(e) {
                  					e.preventDefault();
                  				});
                  				document.getElementById('MobileDrift').addEventListener('contextmenu', function(e) {
                  					e.preventDefault();
                  				});
                  			}
                  			else {
                  				$("#validation").show();
                  				$("#RightMobile").hide();
                  				$("#LeftMobile").hide();
                  				$("#MobileJump").hide();
                  				$("#MobileDrift").hide();
                  				$("#fullscreen").hide();
                  				$("#AltMobileControls").hide();
                  			}
                  
                  			$(document).on('fullscreenchange', function() {
                  				if (document.fullscreenElement) {
                  					$("#fullscreen").hide();
                  				} else {
                  					$("#fullscreen").show();
                  				}
                  			});

            var menu = document.getElementById('cheats');
            var menuInputs = menu.querySelectorAll('input');
            menuInputs.forEach(function(input) {
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'ArrowUp' || event.key === 'ArrowDown' || event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                        event.stopPropagation();
                    }
                });
            });
            // $("#preview").prop("checked", true);

            $(".modmenuOption").hide();
            $(".LevelEditorOption").hide();
            $(".LevelEditorObjects").hide();
            $(".LevelEditorControl").hide();
            $(".LevelEditorAdd").hide();
            $("#cheats").hide();
            $("#gravitytoggle").hide();
            $("#speedtoggle").hide();
            $("#followtoggle").hide();
            $("#dodocontrols").hide();
            $("#challangeMenu").hide();
          
                        $("#overwriteMouseControlsText").hide();
                        $("#overwriteMouseControls").hide();
                        $("#MouseControlsSensitivity").hide();
                        $("#MouseControlsText").hide();
                  
                        $("#fullscreen").click(function() {
                          if (document.fullscreenElement) {
                            exitFullscreenAndUnlockOrientation();
                            window.scrollTo(0, 0);
                          } else {
                            requestFullscreenAndLockOrientation();
                          }
                        });
                  
                        $("#RightMobile").on("mousedown touchstart", function() {
                          window.controls.right = true;
                          window.controls.left = false;
                        });
                  
                        $("#LeftMobile").on("mousedown touchstart", function() {
                          window.controls.left = true;
                          window.controls.right = false;
                        });
                  
                        $("#MobileJump").on("mousedown touchstart", function() {
                          window.controls.space = true;
                        });
                  
                        $("#MobileDrift").on("mousedown touchstart", function() {
                          window.controls.down = true;
                        });
                  
                        $("#AltMobileControls").on("change", function() {
                    // <button id="MobileDrift" style="position:absolute;right:10px;bottom:calc(20px + 10vh * 2);width:13vw;height:10vw;background:rgba(75, 227, 75, .25);border:none;cursor:pointer;">
                  
                          if ($(this).is(":checked")) { // alt
                            $("#RightMobile").css("right", "10px");
                            $("#RightMobile").css("left", "");
                            $("#MobileJump").css("left", "10px");
                            $("#MobileJump").css("right", "");
                            $("#MobileJump").css("bottom", "calc(20px + 10vh * 2)");
                          } else { // normal
                            $("#RightMobile").css("right", "");
                            $("#RightMobile").css("left", "calc(40px + 10vw)");
                            $("#MobileJump").css("right", "10px");
                            $("#MobileJump").css("left", "");
                            $("#MobileJump").css("bottom", "10px");
                          }
                        });
                  
                        $(document).on("mouseup touchend", function() {
                          if (isMapLoaded) {
                            window.controls.right = false;
                            window.controls.left = false;
                            window.controls.space = false;
                            window.controls.down = false;
                          }
                        });
                  
            // $("#testbutton").click(function() {
            //     sphere = BABYLON.MeshBuilder.CreateIcoSphere("icosphere", options = {radius: 3, subdivisions: 4}, scene);
            //     sphere.position = new BABYLON.Vector3(0, 2, -50);
            //     // player.scale = new BABYLON.Vector3(0.1, 0.1, 0.1);
            //     player.scaling = new BABYLON.Vector3(2, 2, 2);
            //     physicsImpostor = new BABYLON.PhysicsImpostor(sphere, BABYLON.PhysicsImpostor.SphereImpostor, { mass: 1, restitution: 1, friction: 0.1}, scene)
            // })

            let lasthighlight;
            $("#ObjectSelector").on("input", function() {
                try{meshes[lasthighlight].showBoundingBox = false;}catch{}
                lasthighlight = $(this).val();
                meshes[$(this).val()].showBoundingBox = true;
            });

            let meshes;
            let platforms;
            let cones;
            let spheres;
            let ends;
            let cylinders;
            let TextureName = [];
            let TextureColor = [];
            function GetAllObjects() {
                meshes = null;
                platforms = null;
                cones = null;
                spheres = null;
                ends = null;
                cylinders = null;
                TextureName = [];
                TextureColor = [];
                document.getElementById("ObjectSelector").innerHTML = "<option> </option>";
                meshes = scene.getMeshesByTags("mesh")
                platforms = scene.getMeshesByTags("platform")
                cones = scene.getMeshesByTags("cone")
                spheres = scene.getMeshesByTags("sphere")
                ends = scene.getMeshesByTags("end")
                cylinders = scene.getMeshesByTags("cylinder")
                for(let i = 0;i < meshes.length;i++) {
                    document.getElementById("ObjectSelector").innerHTML += "<option value="+i+">"+meshes[i].name+"</option>"
                }
                for (let i = 0;i<meshes.length;i++){
                    TextureName.push(meshes[i].material.name);
                    TextureColor.push(meshes[i].material.diffuseColor);
                }
                TextureName = JSON.stringify(TextureName)
                TextureColor = JSON.stringify(TextureColor)
            }
            $("#GetAllObjects").click(function() {
                GetAllObjects();
            })
            $("#DeleteAllMadeObjects").click(function(){
                for(let i = 0;i < boxnum;i++) {
                    scene.getMeshByName("box"+i).dispose()
                }
                for(let i = 0;i < cylindernum;i++) {
                    scene.getMeshByName("cylinder"+i).dispose()
                }
                boxnum = 0;
                cylindernum = 0;
                GetAllObjects()
            })
            $("#DeleteSelectedMadeObjects").click(function(){
                meshes[$("#ObjectSelector").val()].dispose();
                GetAllObjects()
            })
            let boxnum = 0
            let cylindernum = 0
            $("#addBox").click(function() {
                // texture
                let mat = new BABYLON.StandardMaterial("mat", scene);
                mat.diffuseTexture = new BABYLON.Texture("assets/textures/bright.png", scene);
                mat.diffuseTexture.uScale = mat.diffuseTexture.vScale = 1.0;
                mat.backFaceCulling = false;
                mat.freeze();

                let box = BABYLON.MeshBuilder.CreateBox("box"+boxnum, options={size:2}, scene);
                BABYLON.Tags.AddTagsTo(box, "mesh");
                box.physicsImpostor = new BABYLON.PhysicsImpostor(box, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0, friction: 0.6}, scene)
                box.material = mat;
                
                boxnum++
                GetAllObjects()
            })
            $("#addcylinder").click(function() {
                // texture
                let mat = new BABYLON.StandardMaterial("mat", scene);
                mat.diffuseTexture = new BABYLON.Texture("https://awehero.github.io/DodoLoader/assets/textures/bright.png", scene);
                mat.diffuseTexture.uScale = mat.diffuseTexture.vScale = 1.0;
                mat.backFaceCulling = false;
                mat.freeze();

                let cylinder = BABYLON.MeshBuilder.CreateCylinder("cylinder"+cylindernum, options={height:2}, scene);
                cylinder.checkCollisions = true;
                cylinder.applyGravity = false;
                cylinder.isPickable = false;
                scene.collisionsEnabled = true;
                camera.checkCollisions = true;
                BABYLON.Tags.AddTagsTo(cylinder, "mesh");
                cylinder.physicsImpostor = new BABYLON.PhysicsImpostor(cylinder, BABYLON.PhysicsImpostor.CylinderImpostor, { mass: 0, restitution: 0, friction: 0.6}, scene)
                cylinder.material = mat;

                cylindernum++
                GetAllObjects()
            })
            function Transform(x=meshes[$("#ObjectSelector").val()].position.x,y=meshes[$("#ObjectSelector").val()].position.y,z=meshes[$("#ObjectSelector").val()].position.z,
                               xs=meshes[$("#ObjectSelector").val()].scaling.x,ys=meshes[$("#ObjectSelector").val()].scaling.y,zs=meshes[$("#ObjectSelector").val()].scaling.z,
                               xr,yr,zr) {
                try{meshes[$("#ObjectSelector").val()].position = new BABYLON.Vector3(x,y,z)} catch{}
                if (xr != undefined && yr != undefined && zr != undefined) {
                    try{
                        var rotationX = BABYLON.Quaternion.RotationAxis(BABYLON.Axis.X, BABYLON.Tools.ToRadians(xr));
                        var rotationY = BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Y, BABYLON.Tools.ToRadians(yr));
                        var rotationZ = BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Z, BABYLON.Tools.ToRadians(zr));
                        var combinedRotation = rotationZ.multiply(rotationY).multiply(rotationX);
                        meshes[$("#ObjectSelector").val()].rotationQuaternion = combinedRotation;
                    } catch{}
                }
                try{meshes[$("#ObjectSelector").val()].scaling = new BABYLON.Vector3(xs,ys,zs)} catch{}
                if ($("#TextureSelector").val() == ''){}
                else if ($("#TextureSelector").val() == 'bright.png'){meshes[$("#ObjectSelector").val()].material = decorations.bright}
                else if ($("#TextureSelector").val() == 'dark.png'){meshes[$("#ObjectSelector").val()].material = decorations.dark}
                else if ($("#TextureSelector").val() == 'flare.png'){meshes[$("#ObjectSelector").val()].material = decorations.flare}
                else if ($("#TextureSelector").val() == 'icedd.png'){meshes[$("#ObjectSelector").val()].material = decorations.icedd}
                else if ($("#TextureSelector").val() == 'pm1.png'){meshes[$("#ObjectSelector").val()].material = decorations.pm1}
                else if ($("#TextureSelector").val() == 'pm2.png'){meshes[$("#ObjectSelector").val()].material = decorations.pm2}
            }
            $("#ControlButton").click(function() {
                Transform(
                    $("#x").val() !== "" ? $("#x").val() : undefined,$("#y").val() !== "" ? $("#y").val() : undefined,$("#z").val() !== "" ? $("#z").val() : undefined,
                    $("#xs").val() !== "" ? $("#xs").val() : undefined,$("#ys").val() !== "" ? $("#ys").val() : undefined,$("#zs").val() !== "" ? $("#zs").val() : undefined,
                    $("#xr").val() !== "" ? $("#xr").val() : undefined,$("#yr").val() !== "" ? $("#yr").val() : undefined,$("#zr").val() !== "" ? $("#zr").val() : undefined)
            })
            let MapInit = '';
            function Distance3D(x1, y1, z1, x2, y2, z2) {
                return Math.sqrt(
                    Math.abs(Math.pow(x2 - x1, 2)) +
                    Math.abs(Math.pow(y2 - y1, 2)) +
                    Math.abs(Math.pow(z2 - z1, 2))
                );
            }
            let MapScript1;
            let MapScirpt2;
            let MapScirpt3;
            let MapScirpt4;
            // let debugmesh = BABYLON.MeshBuilder.CreateBox("box", options={size: 0.1}, scene);
            // debugmesh.position = new BABYLON.Vector3(vertices[0].x, vertices[0].y, vertices[0].z)
            // debugmesh = BABYLON.MeshBuilder.CreateBox("box", options={size: 0.1}, scene);
            // debugmesh.position = new BABYLON.Vector3(vertices[4].x, vertices[4].y, vertices[4].z)
            function ExportMap() {
                GetAllObjects();
                MapScript1 = 'var map = {title: "EngineV9Level",song: "env2",maker: "Someone",spawn: [0, 0.5, 0],init: function() {let box;';
                MapScirpt2 = `let meshes = scene.getMeshesByTags("mesh");let platforms = scene.getMeshesByTags("platform");let cones = scene.getMeshesByTags("cone");let ends = scene.getMeshesByTags("end");decorations.decorateCustomLevel(meshes, platforms, cones, ends, ${TextureName}, ${TextureColor})},`
                MapScirpt3 = 'post: function() {},section_id: 0,section_update: function() {},reset: function() {},'
                MapScirpt4 = 'player_move: function() {},physics_update: function() {},render_update: function() {},}'
                for (let i = 0; i < platforms.length; i++) {
                    platforms[i].computeWorldMatrix(true);
                    let worldMatrix = platforms[i].getWorldMatrix();

                    let rotationQuaternion = platforms[i].rotationQuaternion;
                    if (!rotationQuaternion) {
                        rotationQuaternion = BABYLON.Quaternion.RotationYawPitchRoll(platforms[i].rotation.y, platforms[i].rotation.x, platforms[i].rotation.z);
                    }
                    let rotation = rotationQuaternion.toEulerAngles();

                    let data = BABYLON.VertexData.ExtractFromMesh(platforms[i]);
                    data.transform(worldMatrix);
                    // 0 1 corners
                    // 0 2 width
                    // 0 3 height
                    // 0 4 depth
                    let boundingBox = platforms[i].getBoundingInfo().boundingBox;
                    let center = boundingBox.center;
                    let vertices = boundingBox.vectorsWorld
                    let width = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[2].x, vertices[2].y, vertices[2].z);
                    let height = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[3].x, vertices[3].y, vertices[3].z);
                    let depth = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[4].x, vertices[4].y, vertices[4].z);

                    MapInit += `box = BABYLON.MeshBuilder.CreateBox('${platforms[i].name}', {size: 1}, scene);
                                box.scaling = new BABYLON.Vector3(${width}, ${height}, ${depth});
                                box.position = new BABYLON.Vector3(${center.x}, ${center.y}, ${center.z});
                                box.physicsImpostor = new BABYLON.PhysicsImpostor(box, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0, friction: 0.6}, scene);
                                box.rotation = new BABYLON.Vector3(${rotation.x}, ${rotation.y}, ${rotation.z});
                                BABYLON.Tags.AddTagsTo(box, 'mesh platform');`;
                }
                for (let i = 0; i < cones.length; i++) {
                    cones[i].computeWorldMatrix(true);
                    let worldMatrix = cones[i].getWorldMatrix();

                    let rotationQuaternion = cones[i].rotationQuaternion;
                    if (!rotationQuaternion) {
                        rotationQuaternion = BABYLON.Quaternion.RotationYawPitchRoll(cones[i].rotation.y, cones[i].rotation.x, cones[i].rotation.z);
                    }
                    let rotation = rotationQuaternion.toEulerAngles();

                    let data = BABYLON.VertexData.ExtractFromMesh(cones[i]);
                    data.transform(worldMatrix);
                    // 0 1 corners
                    // 0 2 width
                    // 0 3 height
                    // 0 4 depth
                    let boundingBox = cones[i].getBoundingInfo().boundingBox;
                    let center = boundingBox.center;
                    let vertices = boundingBox.vectorsWorld
                    let width = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[2].x, vertices[2].y, vertices[2].z);
                    let height = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[3].x, vertices[3].y, vertices[3].z);
                    let depth = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[4].x, vertices[4].y, vertices[4].z);
                    MapInit += `cone = BABYLON.MeshBuilder.CreateCylinder('${cones[i].name}', {diameterTop: 0, diameterBottom:${width}, height:${height-0.1}}, scene);
                                        cone.scaling = new BABYLON.Vector3(${width}, ${height-0.05}, ${depth});
                                        cone.position = new BABYLON.Vector3(${center.x-0.05}, ${center.y}, ${center.z});
                                        cone.rotation = new BABYLON.Vector3(${rotation.x}, ${rotation.y}, ${rotation.z});
                                        cone.physicsImpostor = new BABYLON.PhysicsImpostor(cone, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0, friction: 0.6}, scene);
                                        cone.physicsImpostor.registerOnPhysicsCollide(player.physicsImpostor, function(main, collided) {
                                            window.change_state.die("Died From Cone");
                                        });
                                        BABYLON.Tags.AddTagsTo(cone, 'mesh cone');`;
                }
                for (let i = 0; i < ends.length; i++) {
                    ends[i].computeWorldMatrix(true);
                    let worldMatrix = ends[i].getWorldMatrix();

                    let rotationQuaternion = ends[i].rotationQuaternion;
                    if (!rotationQuaternion) {
                        rotationQuaternion = BABYLON.Quaternion.RotationYawPitchRoll(ends[i].rotation.y, ends[i].rotation.x, ends[i].rotation.z);
                    }
                    let rotation = rotationQuaternion.toEulerAngles();

                    let data = BABYLON.VertexData.ExtractFromMesh(ends[i]);
                    data.transform(worldMatrix);
                    // 0 1 corners
                    // 0 2 width
                    // 0 3 height
                    // 0 4 depth
                    let boundingBox = ends[i].getBoundingInfo().boundingBox;
                    let center = boundingBox.center;
                    let vertices = boundingBox.vectorsWorld
                    let width = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[2].x, vertices[2].y, vertices[2].z);
                    let height = Distance3D(vertices[0].x, vertices[0].y, vertices[0].z, vertices[3].x, vertices[3].y, vertices[3].z);
                    MapInit += `end = BABYLON.MeshBuilder.CreateCylinder('${ends[i].name}', {diameterTop: ${width}, diameterBottom:${width}, height:${height}}, scene);
                                        end.position = new BABYLON.Vector3(${center.x-0.05}, ${center.y}, ${center.z});
                                        end.rotation = new BABYLON.Vector3(${rotation.x}, ${rotation.y}, ${rotation.z});
                                        end.physicsImpostor = new BABYLON.PhysicsImpostor(end, BABYLON.PhysicsImpostor.CylinderImpostor, { mass: 0, restitution: 0, friction: 0.6}, scene);
                                        end.physicsImpostor.registerOnPhysicsCollide(player.physicsImpostor, function(main, collided) {
                                            window.change_state.win();
                                        });
                                        BABYLON.Tags.AddTagsTo(end, 'mesh end');`;
                }
                // eval(MapInit)
                return MapScript1+MapInit+MapScirpt2+MapScirpt3+MapScirpt4
            }
            $("#Export").click(function(){
                const script = ExportMap();
                $("#ExportMap").val(script);
            })

            $('#PracticeX').val('0');
            $('#PracticeY').val('1');
            $('#PracticeZ').val('0');
            $('#PracticeR').val('0');
            $('#gravity').val('-9');
            $('#speed').val('0.28');
            $("#followdistance").val('0.5');
            $("#followheight").val('2.5');
            // $("#followspeed").val('1');
            $("#FollowStart").val('c');
            $("#speedindicator").text($("#speed").val());
            $("#followindicator").text("Max distance"+$("#followdistance").val());
            $("#followheightindicator").text("Max height: "+$("#followheight").val());
            // $("#followspeedindicator").text("Follow speed: "+$("#followspeed").val());

            $("#gravityindicator").text($("#gravity").val());

            $("#togglemenu").click(function () {
                $(".modmenuOption").toggle();
            });
            $("#toggleLevelEditor").click(function () {
                $(".LevelEditorOption").toggle();
            });
            $("#toggleLevelEditorObjects").click(function () {
                $(".LevelEditorObjects").toggle();
            });
            $("#toggleLevelEditorControl").click(function () {
                $(".LevelEditorControl").toggle();
            });
            $("#toggleLevelEditorAdd").click(function () {
                $(".LevelEditorAdd").toggle();
            });
            $("#toggledodocontrols").click(function () {
                $("#dodocontrols").toggle();
            });
            $("#toggletascontrols").click(function () {
                $("#tascontrols").toggle();
            });
            $("#togglecheats").click(function () {
                $("#cheats").toggle();
            });
            $("#gravityoverwrite").click(function () {
                $("#gravitytoggle").toggle();
            });
            $("#speedoverwrite").click(function () {
                $("#speedtoggle").toggle();
            });
            $("#togglechallages").click(function () {
                $("#challangeMenu").toggle();
            });
            $("#follow").on("input", function() {
                $("#followtoggle").toggle();
                $("#freecam").prop("checked", true);
            });
                        let MouseControls = false;
                  			let MouseControlsSensitivity = 1;
                  			// let OGmouse = false;
                  			$("#MouseControls").on("input", function() {
                  				$("#overwriteMouseControls").toggle();
                  				$("#overwriteMouseControlsText").toggle();
                  				MouseControls = !MouseControls;
                  				document.addEventListener("click", () => {
                  					if (isMapLoaded && MouseControls) document.body.requestPointerLock();
                  				});
                  
                  				document.addEventListener("mousemove", (event) => {
                  					if (document.pointerLockElement === document.body && isMapLoaded && MouseControls) {
                  						let rotationChange = event.movementX * 0.002 * MouseControlsSensitivity;
                  						if (!MouseStearOverwrite) {
                  							rotationChange = Math.max(Math.min(rotationChange, steer), -steer);
                  							rotation += rotationChange;
                  
                  							document.addEventListener("mousedown", () => {
                  								window.controls.space = true;
                  							});
                  
                  							document.addEventListener("mouseup", () => {
                  								window.controls.space = false;
                  							});
                  						}
                  						else rotation += rotationChange;
                  					}
                  				});
                  
                  				document.addEventListener("pointerlockchange", () => {
                  					if (document.pointerLockElement !== document.body && isMapLoaded && MouseControls) {
                  						console.log("Pointer unlocked");
                  					}
                  				});
                  			});
                  			let MouseStearOverwrite = false;
                  			$("#overwriteMouseControls").on("input", function() {
                  				$("#MouseControlsSensitivity").toggle();
                  				$("#MouseControlsText").toggle();
                  				MouseControlsSensitivity = 1;
                  				MouseStearOverwrite = !MouseStearOverwrite;
                  			});

          
            $("#gravity").on("input", function() {
                $("#gravityindicator").text($(this).val());
            });
            $("#speed").on("input", function() {
                $("#speedindicator").text($(this).val());
            });
            window.followDistance = 0.5;
            $("#followdistance").on("input", function() {
                $("#followindicator").text($(this).val());
                window.followDistance = parseFloat($(this).val());
            });
            window.followHeight = 2;
            $("#followheight").on("input", function() {
                $("#followheightindicator").text("keep height: "+$(this).val());
                window.followHeight = parseFloat($(this).val());
            });
                        $("#MouseControlsSensitivity").on("input", function() {
                    				MouseControlsSensitivity = parseFloat($(this).val());
                    				$("#MouseControlsText").text("Sensitivity: "+$(this).val());
                  			});
            // window.followSpeed = 1;
            // $("#followspeed").on("input", function() {
            //     $("#followspeedindicator").text("Follow speed: "+$(this).val());
            //     window.followSpeed = parseFloat($(this).val());
            // });
            $(document).keypress(function(event) {
                // move
                if (event.key === "j") {
                    camera.position.x += 1;
                }
                if (event.key === "l") {
                    camera.position.x -= 1;
                }
                if (event.key === "k") {
                    camera.position.z += 1;
                }
                if (event.key === "i") {
                    camera.position.z -= 1;
                }
                if (event.key === "p") {
                    camera.position.y += 1;
                }
                if (event.key === ";") {
                    camera.position.y -= 1;
                }
                // rotation
                if (event.key === "J") {
                    camera.rotation.y -= .25;
                }
                if (event.key === "L") {
                    camera.rotation.y += .25;
                }
                if (event.key === "K") {
                    camera.rotation.x += .25;
                }
                if (event.key === "I") {
                    camera.rotation.x -= .25;
                }
                // practice
                if (event.key === "v") { // add point
                    NewCheckpoint()
                }
                if (event.key === "b") { // remove last point
                    window.checkpoints.pop();
                    scene.getMeshByName("checkpoint"+window.checkpointNum).dispose();
                }
            });
            function NewCheckpoint() {
                window.checkpointNum++;
                window.checkpoints.push([player.position.x, player.position.y, player.position.z, rotation]);
                let checkpoint;
                if ($("#CheckpointShape").val() == "sphere"){checkpoint = BABYLON.Mesh.CreateSphere("checkpoint"+window.checkpointNum, 10, 1, scene);}
                else if ($("#CheckpointShape").val() == "cube"){checkpoint = BABYLON.MeshBuilder.CreateBox("checkpoint"+window.checkpointNum, options={size:0.5}, scene);}
                else {checkpoint = BABYLON.Mesh.CreatePolyhedron("checkpoint"+window.checkpointNum, {type: parseInt($("#CheckpointShape").val()), size: 0.75}, scene);}
                checkpoint.position = new BABYLON.Vector3(player.position.x, player.position.y+.5, player.position.z);
                checkpoint.rotation = new BABYLON.Vector3(0, rotation, 0);
                checkpoint.applyGravity = false;
                checkpoint.isPickable = false;
                BABYLON.Tags.AddTagsTo(checkpoint, "checkpoint");
                checkpoint.material = decorations.rgba_mat(34,139,34,0.4, true);
            }
            let progressChecker = setInterval(function() {
                if (isMapLoaded && alive) {
                    let distance = Math.sqrt((Math.abs(player.position.x-window.end.position.x)^2)+(Math.abs(player.position.z-window.end.position.z)^2))-2
                    // console.log(Math.abs(1-distance/window.ogdistance).toFixed(2))
                    $("#progressPercent").text("Level Progress: "+(Math.abs(1-distance/window.ogdistance).toFixed(2)*100).toFixed(0)+"%");
                    $("#progress").val((Math.abs(1-distance/window.ogdistance).toFixed(2)*100).toFixed(0));
                }
            }, 100);
            let AutoCheckpoint = setInterval(function(){
                if (isMapLoaded && $("#AutoCheckpoint").is(":checked") && alive) {
                    NewCheckpoint();
                }
            }, 2000)
        });
        $("#resetlevel").click(function() {
            removeMap(currentMapId);
            window.location.reload();
        })
        function removeMap(mapId) {
            let completedMaps = JSON.parse(localStorage.getItem("completedMaps")) || [];
            completedMaps = completedMaps.filter(map => map.mapId !== mapId);
            localStorage.setItem("completedMaps", JSON.stringify(completedMaps));
        }
        $("#steerControl").val(1)
        window.steerControl = 1;
        $("#steerControl").on("input", function() {
            window.steerControl = parseFloat($(this).val());
            $("#steerindicator").text("Steer Control: "+$(this).val());
        });
        function makeFog() {
            // close layer
            let fog = BABYLON.MeshBuilder.CreateSphere("fog", options={diameter:20}, scene);
            BABYLON.Tags.AddTagsTo(fog, "fog");
            fog.material = decorations.rgba_mat(100, 100, 100, 0.85);
            // far layer
            let fog2 = BABYLON.MeshBuilder.CreateSphere("fog2", options={diameter:35}, scene);
            BABYLON.Tags.AddTagsTo(fog2, "fog");
            fog2.material = decorations.rgba_mat(100, 100, 100, 0.99);
        }
        $("#fog").on("input", function() {
            if ($("#fog").is(":checked")) {
                makeFog();
            } else {
                scene.getMeshByName("fog").dispose();
                scene.getMeshByName("fog2").dispose();
            }
        });
        window.psupdateSpeed = 0.02;
        $("#invis").on("input", function() {
            if ($("#invis").is(":checked")) {
                player.visibility = 0;
                window.psupdateSpeed = 0.0001;
                window.ps.dispose();
                decorations.add_particle_system();
            } else {
                player.visibility = 1;
                window.psupdateSpeed = 0.02
                window.ps.dispose();
                decorations.add_particle_system();
            }
        });
        window.paused = false;
        $("#pause").on("click", function() {
            if (!window.paused) {
                let count = 3;
                window.paused = true;
            } else {
                let count = 3;
                $('#pauseCountDown').show();
                $('#pauseCountDown').text(count);

                const countdownInterval = setInterval(function() {
                    count--;
                    $('#pauseCountDown').text(count);
                    if (count <= 0) {
                        clearInterval(countdownInterval);
                        $('#pauseCountDown').text('Unpaused');
                        window.paused = false;
                        $('#pauseCountDown').hide();
                    }
                }, 1000);
            }
        });
        // ghostly (scratched)
        // let GhostlyAlpha = 0.3;
        // const originalAlphas = new Map();

        // $("#ghostly").on("input", function() {
        //     if ($("#ghostly").is(":checked")) {
        //         const taggedMeshes = scene.getMeshesByTags("mesh");

        //         taggedMeshes.forEach(mesh => {
        //             if (mesh.material) {
        //                 if (!originalAlphas.has(mesh.uniqueId)) {
        //                     originalAlphas.set(mesh.uniqueId, mesh.material.alpha);
        //                 }
        //                 mesh.material.alpha = GhostlyAlpha;
        //             } else {
        //                 const material = new BABYLON.StandardMaterial("tempMaterial", scene);
        //                 material.alpha = GhostlyAlpha;
        //                 mesh.material = material;
        //                 mesh._temporaryMaterial = true;
        //             }
        //         });
        //     } else {
        //         const taggedMeshes = scene.getMeshesByTags("mesh");

        //         taggedMeshes.forEach(mesh => {
        //             if (originalAlphas.has(mesh.uniqueId)) {
        //                 if (mesh.material) {
        //                     if (mesh._temporaryMaterial) {
        //                         mesh.material.dispose();
        //                         mesh.material = null;
        //                         delete mesh._temporaryMaterial;
        //                     } else {
        //                         mesh.material.alpha = originalAlphas.get(mesh.uniqueId);
        //                     }
        //                 }
        //             }
        //         });

        //         originalAlphas.clear();
        //     }
        // });



    </script>

    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/libraries/babylon.js"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/fov.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/change_state.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/maker.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/alias.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/const_controller.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/cleanup.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/start.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/update.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/flyjump.js?v=0.179"></script>
    <script type="text/javascript" src="https://awehero.github.io/DodoLoader/scripts/boot.js?v=0.179"></script>
</body>
</html>

